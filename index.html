<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram Бот - Путешествия</title>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=42675ca1-e0b2-42e3-bb5c-609622616a65" type="text/javascript"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #map {
            width: 100%;
            height: 500px;
            margin-top: 20px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .selection-mode {
            margin-bottom: 15px;
        }
        .selection-mode label {
            margin-right: 10px;
        }
        #confirmButton {
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>

    <h1>Планирование путешествия</h1>

    <div class="selection-mode">
        <label><input type="radio" name="selection" value="from" checked> Отправление</label>
        <label><input type="radio" name="selection" value="to"> Назначение</label>
    </div>

    <div class="input-group">
        <label for="from">Место отправления:</label>
        <input type="text" id="from" placeholder="Начните вводить адрес...">
    </div>

    <div class="input-group">
        <label for="to">Место назначения:</label>
        <input type="text" id="to" placeholder="Начните вводить адрес...">
    </div>

    <button id="confirmButton">Подтвердить</button>

    <div id="map"></div>

    <script type="text/javascript">
        ymaps.ready(init);

        function init() {
            // Создаём карту
            var myMap = new ymaps.Map("map", {
                center: [55.751244, 37.618423], // Москва
                zoom: 10
            });

            // Переменные для меток
            var fromPlacemark = null;
            var toPlacemark = null;

            // Инициализация подсказок автозаполнения
            var suggestViewFrom = new ymaps.SuggestView('from');
            var suggestViewTo = new ymaps.SuggestView('to');

            // Обработчик выбора места отправления
            suggestViewFrom.events.add('select', function (event) {
                var selected = event.get('item').value;
                geocodeAddress(selected, function (coords) {
                    if (fromPlacemark) {
                        myMap.geoObjects.remove(fromPlacemark);
                    }
                    fromPlacemark = createPlacemark(coords, 'islands#greenCircleIcon');
                    myMap.geoObjects.add(fromPlacemark);
                    myMap.setCenter(coords, 12, {
                        checkZoomRange: true
                    });
                });
            });

            // Обработчик выбора места назначения
            suggestViewTo.events.add('select', function (event) {
                var selected = event.get('item').value;
                geocodeAddress(selected, function (coords) {
                    if (toPlacemark) {
                        myMap.geoObjects.remove(toPlacemark);
                    }
                    toPlacemark = createPlacemark(coords, 'islands#redCircleIcon');
                    myMap.geoObjects.add(toPlacemark);
                    myMap.setCenter(coords, 12, {
                        checkZoomRange: true
                    });
                });
            });

            // Функция геокодирования адреса
            function geocodeAddress(address, callback) {
                ymaps.geocode(address, { results: 1 }).then(function (res) {
                    var obj = res.geoObjects.get(0);
                    if (obj) {
                        var coords = obj.geometry.getCoordinates();
                        callback(coords);
                    } else {
                        alert("Адрес не найден: " + address);
                    }
                });
            }

            // Функция создания метки
            function createPlacemark(coords, preset) {
                return new ymaps.Placemark(coords, {}, {
                    preset: preset,
                    draggable: true
                });
            }

            // Определение текущего режима выбора точки
            var currentSelection = 'from'; // По умолчанию отправление

            var radioButtons = document.getElementsByName('selection');
            radioButtons.forEach = Array.prototype.forEach;
            radioButtons.forEach(function(radio) {
                radio.addEventListener('change', function(event) {
                    currentSelection = event.target.value;
                });
            });

            // Позволяет выбирать места напрямую на карте
            myMap.events.add('click', function (e) {
                var coords = e.get('coords');

                // Создание метки в зависимости от текущего выбора (from или to)
                if (currentSelection === 'from') {
                    if (fromPlacemark) {
                        myMap.geoObjects.remove(fromPlacemark);
                    }
                    fromPlacemark = createPlacemark(coords, 'islands#greenCircleIcon');
                    myMap.geoObjects.add(fromPlacemark);
                    ymaps.geocode(coords).then(function (res) {
                        var address = res.geoObjects.get(0).getAddressLine();
                        document.getElementById('from').value = address;
                    });
                } else if (currentSelection === 'to') {
                    if (toPlacemark) {
                        myMap.geoObjects.remove(toPlacemark);
                    }
                    toPlacemark = createPlacemark(coords, 'islands#redCircleIcon');
                    myMap.geoObjects.add(toPlacemark);
                    ymaps.geocode(coords).then(function (res) {
                        var address = res.geoObjects.get(0).getAddressLine();
                        document.getElementById('to').value = address;
                    });
                }
            });

            // Обработка нажатия на кнопку "Подтвердить"
            document.getElementById('confirmButton').addEventListener('click', function() {
                if (fromPlacemark && toPlacemark) {
                    var fromCoords = fromPlacemark.geometry.getCoordinates();
                    var toCoords = toPlacemark.geometry.getCoordinates();
                    var fromAddress = document.getElementById('from').value;
                    var toAddress = document.getElementById('to').value;
                    sendDataToBot(fromAddress, fromCoords, toAddress, toCoords);
                } else {
                    alert("Пожалуйста, выберите места отправления и назначения.");
                }
            });

            // Функция отправки данных в Telegram бот
            function sendDataToBot(fromAddress, fromCoords, toAddress, toCoords) {
                if (window.Telegram.WebApp) {
                    const data = {
                        from: {
                            address: fromAddress,
                            coordinates: fromCoords
                        },
                        to: {
                            address: toAddress,
                            coordinates: toCoords
                        }
                    };
                    // Передача данных обратно в Telegram бота
                    window.Telegram.WebApp.sendData(JSON.stringify(data));
                } else {
                    console.log("Telegram WebApp не найден");
                }
            }
        }
    </script>

</body>
</html>
