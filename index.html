<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram Бот - Путешествия</title>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&amp;apikey=42675ca1-e0b2-42e3-bb5c-609622616a65" type="text/javascript"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #map {
            width: 100%;
            height: 500px;
            margin-top: 20px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

    <h1>Планирование путешествия</h1>

    <div class="input-group">
        <label for="from">Место отправления:</label>
        <input type="text" id="from" placeholder="Начните вводить адрес...">
    </div>

    <div class="input-group">
        <label for="to">Место назначения:</label>
        <input type="text" id="to" placeholder="Начните вводить адрес...">
    </div>

    <div>
        <button id="confirmButton">Подтвердить</button>
    </div>

    <div id="map"></div>
    

    <script type="text/javascript">
        ymaps.ready(init);

        function init() {
            // Создаем карту
            var myMap = new ymaps.Map("map", {
                center: [55.751244, 37.618423], // Москва
                zoom: 10
            });

            // Создаем объекты для меток отправления и назначения
            var fromPlacemark = null;
            var toPlacemark = null;

            // Инициализация подсказок автозаполнения
            var suggestViewFrom = new ymaps.SuggestView('from');
            var suggestViewTo = new ymaps.SuggestView('to');

            // Обработчик выбора места отправления
            suggestViewFrom.events.add('select', function (event) {
                var selected = event.get('item').value;
                geocodeAddress(selected, function (coords) {
                    if (fromPlacemark) {
                        myMap.geoObjects.remove(fromPlacemark);
                    }
                    fromPlacemark = createPlacemark(coords);
                    myMap.geoObjects.add(fromPlacemark);
                    myMap.setCenter(coords, 12, {
                        checkZoomRange: true
                    });
                });
            });

            // Обработчик выбора места назначения
            suggestViewTo.events.add('select', function (event) {
                var selected = event.get('item').value;
                geocodeAddress(selected, function (coords) {
                    if (toPlacemark) {
                        myMap.geoObjects.remove(toPlacemark);
                    }
                    toPlacemark = createPlacemark(coords);
                    myMap.geoObjects.add(toPlacemark);
                    myMap.setCenter(coords, 12, {
                        checkZoomRange: true
                    });
                });
            });

            // Функция геокодирования адреса
            function geocodeAddress(address, callback) {
                ymaps.geocode(address, { results: 1 }).then(function (res) {
                    var obj = res.geoObjects.get(0);
                    if (obj) {
                        var coords = obj.geometry.getCoordinates();
                        callback(coords);
                    } else {
                        alert("Адрес не найден: " + address);
                    }
                });
            }

            // Функция создания метки
            function createPlacemark(coords) {
                return new ymaps.Placemark(coords, {}, {
                    preset: 'islands#blueCircleIcon',
                    draggable: true
                });
            }

            // После выбора мест и подтверждения выбора
            function sendDataToBot(fromAddress, fromCoords, toAddress, toCoords) {
                if (window.Telegram.WebApp) {
                    const data = {
                        from: {
                            address: fromAddress,
                            coordinates: fromCoords
                        },
                        to: {
                            address: toAddress,
                            coordinates: toCoords
                        }
                    };
                    // Отправка данных обратно в Telegram бота
                    window.Telegram.WebApp.sendData(JSON.stringify(data));
                } else {
                    console.log("Telegram WebApp not found");
                }
            }
            
            // Пример вызова функции после выбора обоих мест
            // Предположим, что пользователь нажал кнопку "Подтвердить"
            document.getElementById('confirmButton').addEventListener('click', function() {
                if (fromPlacemark && toPlacemark) {
                    var fromCoords = fromPlacemark.geometry.getCoordinates();
                    var toCoords = toPlacemark.geometry.getCoordinates();
                    var fromAddress = document.getElementById('from').value;
                    var toAddress = document.getElementById('to').value;
                    sendDataToBot(fromAddress, fromCoords, toAddress, toCoords);
                } else {
                    alert("Пожалуйста, выберите места отправления и назначения.");
                }
            });

            // Дополнительно: Позволяет выбирать места напрямую на карте
            myMap.events.add('click', function (e) {
                var coords = e.get('coords');
                // Если пользователь выбирает место отправления
                if (document.activeElement === document.getElementById('from')) {
                    if (fromPlacemark) {
                        myMap.geoObjects.remove(fromPlacemark);
                    }
                    fromPlacemark = createPlacemark(coords);
                    myMap.geoObjects.add(fromPlacemark);
                    ymaps.geocode(coords).then(function (res) {
                        var address = res.geoObjects.get(0).getAddressLine();
                        document.getElementById('from').value = address;
                    });
                }
                // Если пользователь выбирает место назначения
                else if (document.activeElement === document.getElementById('to')) {
                    if (toPlacemark) {
                        myMap.geoObjects.remove(toPlacemark);
                    }
                    toPlacemark = createPlacemark(coords);
                    myMap.geoObjects.add(toPlacemark);
                    ymaps.geocode(coords).then(function (res) {
                        var address = res.geoObjects.get(0).getAddressLine();
                        document.getElementById('to').value = address;
                    });
                }
            });
        }
    </script>

</body>
</html>
